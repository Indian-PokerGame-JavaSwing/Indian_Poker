package g_GamePage;

import normalclass.Card;
import javax.swing.*;
import java.awt.*;
import java.io.*;
import java.net.Socket;

/**
 * ë„¤íŠ¸ì›Œí¬ ê¸°ë°˜ ì¸ë””ì–¸ í¬ì»¤ í´ë¼ì´ì–¸íŠ¸
 * 
 * ì—­í• :
 *   - ì„œë²„ì— ì ‘ì†í•˜ì—¬ ROUND/RESULT ë©”ì‹œì§€ë¥¼ ìˆ˜ì‹ 
 *   - CALL / FOLD ë²„íŠ¼ ì…ë ¥ì„ ì„œë²„ë¡œ ì „ì†¡
 *   - ì„œë²„ ë©”ì‹œì§€ì— ë”°ë¼ ì¹´ë“œ ì´ë¯¸ì§€ ë° UI ê°±ì‹ 
 * 
 * ê²Œì„ ë¡œì§ì€ ëª¨ë‘ ì„œë²„ê°€ ì²˜ë¦¬í•˜ê³ 
 * í´ë¼ì´ì–¸íŠ¸ëŠ” UI í‘œì‹œ + ì…ë ¥ë§Œ ë‹´ë‹¹í•œë‹¤.
 */
public class PlayIndianPoker extends JFrame {

    // ===============================
    //  UI ì»´í¬ë„ŒíŠ¸
    // ===============================
    private JLabel lblEnemyCard, lblUserCard, lblPot, lblMoney, lblInfo;
    private JButton btnCall, btnRaise, btnAllIn, btnFold;
    private JTextField txtRaise;

    // ===============================
    //  ë„¤íŠ¸ì›Œí¬ í†µì‹  ê´€ë ¨
    // ===============================
    private Socket socket;
    private BufferedWriter out;
    private BufferedReader in;

    private final String SERVER_IP = "localhost"; // ë¡œì»¬ í…ŒìŠ¤íŠ¸
    private final int SERVER_PORT = 50000;

    // ===============================
    //  ì„œë²„ê°€ ë³´ë‚´ì£¼ëŠ” ê²Œì„ ìƒíƒœ
    // ===============================
    private Card myCard;
    private Card enemyCard;
    private int myMoney;
    private int enemyMoney;
    private int pot;

    // ===============================
    //  ì¹´ë“œ ì´ë¯¸ì§€ ê²½ë¡œ
    // ===============================
    private final String CARD_IMG_DIR = System.getProperty("user.dir") + "/src/plus_Card/";
    private final String CARD_BACK_IMG = System.getProperty("user.dir") + "/src/plus_Card/CardBackImg.png";

    /**
     * í´ë¼ì´ì–¸íŠ¸(UI) ìƒì„±ì
     * UI êµ¬ì„± â†’ ì„œë²„ ì ‘ì† â†’ ë©”ì‹œì§€ ìˆ˜ì‹  ìŠ¤ë ˆë“œ ì‹œì‘
     */
    public PlayIndianPoker() {
        setTitle("Indian Poker Online");
        setDefaultCloseOperation(JFrame.EXIT_ON_CLOSE);
        setSize(820, 620);
        setLocationRelativeTo(null);
        setLayout(new BorderLayout());

        initUI();          // UI êµ¬ì„±
        connectToServer(); // ì„œë²„ ì—°ê²°
        startReceiver();   // ì„œë²„ ë©”ì‹œì§€ ìˆ˜ì‹  ìŠ¤ë ˆë“œ

        setVisible(true);
    }

    // ===============================
    //  UI êµ¬ì„±
    // ===============================
    private void initUI() {

        // ìƒë‹¨: ì •ë³´ í…ìŠ¤íŠ¸ + íŒŸ í‘œì‹œ
        JPanel top = new JPanel(new BorderLayout());
        lblInfo = new JLabel("ìƒëŒ€ í”Œë ˆì´ì–´ë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...", SwingConstants.LEFT);
        lblInfo.setFont(new Font("Dialog", Font.BOLD, 16));

        lblPot = new JLabel("POT: 0", SwingConstants.RIGHT);
        lblPot.setFont(new Font("Dialog", Font.BOLD, 16));

        top.add(lblInfo, BorderLayout.WEST);
        top.add(lblPot, BorderLayout.EAST);
        add(top, BorderLayout.NORTH);

        // ì¤‘ì•™: ë‚´ ì¹´ë“œ / ìƒëŒ€ ì¹´ë“œ í‘œì‹œ
        JPanel center = new JPanel(new GridLayout(1, 2, 20, 0));
        center.setBorder(BorderFactory.createEmptyBorder(10, 60, 10, 60));

        lblUserCard = createCardLabel();
        lblEnemyCard = createCardLabel();

        center.add(titled(lblUserCard, "ë‚´ ì¹´ë“œ"));
        center.add(titled(lblEnemyCard, "ìƒëŒ€ ì¹´ë“œ"));
        add(center, BorderLayout.CENTER);

        // í•˜ë‹¨: ëˆ í‘œì‹œ + CALL/FOLD ë²„íŠ¼
        JPanel bottom = new JPanel(new BorderLayout());
        lblMoney = new JLabel("ë‚˜: 200ì› | ìƒëŒ€: 200ì›", SwingConstants.CENTER);
        lblMoney.setFont(new Font("Dialog", Font.PLAIN, 14));

        JPanel btnPanel = new JPanel();
        btnCall = new JButton("CALL");
        btnRaise = new JButton("RAISE");
        btnAllIn = new JButton("ALL-IN");
        btnFold = new JButton("FOLD");
        
        // Raise ê¸ˆì•¡ ì…ë ¥ì°½
        txtRaise = new JTextField("20",5);

        // ë²„íŠ¼ í´ë¦­ ì‹œ ì„œë²„ì— CALL/RAISE/ALLIN/FOLD ì „ì†¡
        btnCall.addActionListener(e -> sendToServer("CALL"));
        btnRaise.addActionListener(e -> {
        	String text = txtRaise.getText().trim();
        	
        	// ê¸ˆì•¡ì´ ìˆ«ìì¸ì§€ ê²€ì‚¬
        	if (!text.matches("\\d+")) {
        		JOptionPane.showMessageDialog(this, "ìˆ«ìë§Œ ì…ë ¥ ê°€ëŠ¥í•©ë‹ˆë‹¤!", "ì…ë ¥ ì˜¤ë¥˜", JOptionPane.WARNING_MESSAGE);
        		return;
        	}
        	int raiseAmount = Integer.parseInt(text);
        	
        	// í˜„ì¬ ê¸ˆì•¡ë³´ë‹¤ í°ì§€ ê²€ì‚¬
        	if (raiseAmount > myMoney) {
        		JOptionPane.showMessageDialog(this,
        				"ë³´ìœ  ê¸ˆì•¡("+myMoney+"ì›) ì´ˆê³¼ ê¸ˆì•¡ì€ ë² íŒ…í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!",
        				"ë² íŒ… ë¶ˆê°€",
        				JOptionPane.WARNING_MESSAGE);
        		return;
        	}
        	sendToServer("RAISE"+raiseAmount);
        	
        });
        btnAllIn.addActionListener(e -> sendToServer("ALLIN"));
        btnFold.addActionListener(e -> sendToServer("FOLD"));

        btnPanel.add(btnCall);
        btnPanel.add(btnRaise);
        btnPanel.add(txtRaise);
        btnPanel.add(btnAllIn);
        btnPanel.add(btnFold);

        bottom.add(lblMoney, BorderLayout.NORTH);
        bottom.add(btnPanel, BorderLayout.SOUTH);
        add(bottom, BorderLayout.SOUTH);
    }

    // ì¹´ë“œ í‘œì‹œìš© ê¸°ë³¸ JLabel ìƒì„±
    private JLabel createCardLabel() {
        JLabel l = new JLabel("", SwingConstants.CENTER);
        l.setPreferredSize(new Dimension(260, 360));
        l.setBorder(BorderFactory.createLineBorder(Color.GRAY));
        return l;
    }

    // ì œëª© + ì»´í¬ë„ŒíŠ¸ ì„¸íŠ¸ë¡œ ë¬¶ê¸°
    private JPanel titled(JComponent comp, String title) {
        JPanel p = new JPanel(new BorderLayout());
        JLabel t = new JLabel(title, SwingConstants.CENTER);
        t.setFont(new Font("Dialog", Font.BOLD, 14));
        p.add(t, BorderLayout.NORTH);
        p.add(comp, BorderLayout.CENTER);
        return p;
    }

    // ===============================
    //  ì„œë²„ ì—°ê²°
    // ===============================
    private void connectToServer() {
        try {
            socket = new Socket(SERVER_IP, SERVER_PORT);

            // ì†Œì¼“ ìŠ¤íŠ¸ë¦¼ ì¤€ë¹„
            out = new BufferedWriter(new OutputStreamWriter(socket.getOutputStream()));
            in  = new BufferedReader(new InputStreamReader(socket.getInputStream()));

            setInfo("ìƒëŒ€ í”Œë ˆì´ì–´ ì ‘ì† ëŒ€ê¸°ì¤‘...");

        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    // ===============================
    //  ì„œë²„ ë©”ì‹œì§€ ìˆ˜ì‹  ìŠ¤ë ˆë“œ
    // ===============================
    private void startReceiver() {
        new Thread(() -> {
            try {
                String msg;

                // ì„œë²„ê°€ ë³´ë‚¼ ë•Œê¹Œì§€ ê³„ì† ìˆ˜ì‹ 
                while ((msg = in.readLine()) != null) {
                    handleMessage(msg); // ë©”ì‹œì§€ ë¶„ë¥˜ ë° ì²˜ë¦¬
                }

            } catch (Exception e) {
                e.printStackTrace();
            }
        }).start();
    }

    // ===============================
    //  ì„œë²„ ë©”ì‹œì§€ ì²˜ë¦¬
    // ===============================
    private void handleMessage(String msg) {
        String[] t = msg.split(" ");

        switch (t[0]) {

            // ------------------------------------
            //  ROUND: ìƒˆ ë¼ìš´ë“œ ì‹œì‘
            // ------------------------------------
            case "ROUND":
                myMoney    = Integer.parseInt(t[1]);
                enemyMoney = Integer.parseInt(t[2]);
                pot        = Integer.parseInt(t[3]);

                int visibleNum   = Integer.parseInt(t[4]);
                int visibleShape = Integer.parseInt(t[5]);

                enemyCard = new Card(visibleNum, visibleShape);

                SwingUtilities.invokeLater(() -> {
                    // ë‚´ ì¹´ë“œëŠ” ë’·ë©´
                    lblUserCard.setIcon(loadBackIcon());

                    // ìƒëŒ€ ì¹´ë“œëŠ” ì•ë©´(ë³´ì´ëŠ” ì¹´ë“œ)
                    lblEnemyCard.setIcon(loadCardFrontIcon(enemyCard));

                    // UIì— ìƒí™© ê°±ì‹ 
                    lblMoney.setText("ë‚˜: " + myMoney + "ì› | ìƒëŒ€: " + enemyMoney + "ì›");
                    lblPot.setText("POT: " + pot);
                    setInfo("CALL / RAISE / ALL-IN / FOLD ì„ íƒí•˜ì„¸ìš”!");

                    // ìƒˆë¡œìš´ ë¼ìš´ë“œ â†’ ë²„íŠ¼ ë‹¤ì‹œ í™œì„±í™”
                    btnCall.setEnabled(true);
                    btnFold.setEnabled(true);
                });
                break;

            // ------------------------------------
            //  RESULT: ìŠ¹íŒ¨ ê²°ê³¼ ê³µê°œ
            // ------------------------------------
            case "RESULT":

                String result = t[1];

                int myNum = Integer.parseInt(t[2]);
                int myShp = Integer.parseInt(t[3]);
                int enNum = Integer.parseInt(t[4]);
                int enShp = Integer.parseInt(t[5]);

                int newMyMoney    = Integer.parseInt(t[6]);
                int newEnemyMoney = Integer.parseInt(t[7]);

                myCard    = new Card(myNum, myShp);
                enemyCard = new Card(enNum, enShp);

                SwingUtilities.invokeLater(() -> {
                    // ê²°ê³¼ ê³µê°œ â†’ ë‚´ ì¹´ë“œë„ ì•ë©´
                    lblUserCard.setIcon(loadCardFrontIcon(myCard));
                    lblEnemyCard.setIcon(loadCardFrontIcon(enemyCard));

                    lblMoney.setText("ë‚˜: " + newMyMoney + "ì› | ìƒëŒ€: " + newEnemyMoney + "ì›");
                    setInfo("ê²°ê³¼: " + result + " (ë‹¤ìŒ ë¼ìš´ë“œë¥¼ ê¸°ë‹¤ë¦¬ëŠ” ì¤‘...)");
                });
                break;
            /// ---------------------------------
            /// NEXT : ë‹¤ìŒ ë¼ìš´ë“œ ì§„í–‰
            /// ---------------------------------
            case "NEXT":
                SwingUtilities.invokeLater(() -> {
                    lblUserCard.setIcon(loadBackIcon());
                    lblEnemyCard.setIcon(loadBackIcon());
                    setInfo("ë‹¤ìŒ ë¼ìš´ë“œë¥¼ ì¤€ë¹„ ì¤‘...");
                });
                break;

                // ------------------------------------
                //  GAMEOVER : ìµœì¢… ìŠ¹ë¦¬ì
                // ------------------------------------
            case "GAMEOVER":
                String winner = t[1];

                SwingUtilities.invokeLater(() -> {
                    lblInfo.setText(winner + " ìŠ¹ë¦¬! ê²Œì„ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.");

                    // ğŸ’¥ ìµœì¢… ì¹´ë“œë„ ì•ë©´ìœ¼ë¡œ í‘œì‹œ (ë§ˆë¬´ë¦¬ ì—°ì¶œ)
                    lblUserCard.setIcon(loadCardFrontIcon(myCard));
                    lblEnemyCard.setIcon(loadCardFrontIcon(enemyCard));

                    // ëª¨ë“  ë²„íŠ¼ ë¹„í™œì„±í™”
                    btnCall.setEnabled(false);
                    btnRaise.setEnabled(false);
                    btnAllIn.setEnabled(false);
                    btnFold.setEnabled(false);

                    // ë²„íŠ¼ ëŒ€ì‹  ì¢…ë£Œ ë²„íŠ¼ í•˜ë‚˜ ìƒì„±
                    JButton exitButton = new JButton("ê²Œì„ ì¢…ë£Œ");
                    exitButton.setFont(new Font("Dialog", Font.BOLD, 20));

                    exitButton.addActionListener(e -> {
                        try {
                            socket.close();
                        } catch (IOException ignored) {}
                        System.exit(0);
                    });

                    // ê¸°ì¡´ íŒ¨ë„ì— ì¶”ê°€
                    JOptionPane.showMessageDialog(null, winner + " ìŠ¹ë¦¬! ê²Œì„ì„ ì¢…ë£Œí•©ë‹ˆë‹¤.");
                    getContentPane().add(exitButton, BorderLayout.CENTER);
                    revalidate();
                    repaint();
                });
                break;
        }
    }

    // ===============================
    //  CALL/FOLD ì„œë²„ë¡œ ì „ì†¡
    // ===============================
    private void sendToServer(String s) {
        try {
            out.write(s + "\n");
            out.flush();

            // ì…ë ¥ ì™„ë£Œ â†’ ë²„íŠ¼ ë¹„í™œì„±í™” (ë‹¤ìŒ ë¼ìš´ë“œì—ì„œ ë‹¤ì‹œ í™œì„±í™”ë¨)
            btnCall.setEnabled(false);
            btnFold.setEnabled(false);

        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    // ===============================
    //  ì¹´ë“œ ì´ë¯¸ì§€ ë¡œë”©
    // ===============================
    private Icon loadCardFrontIcon(Card c) {
        int num = c.getCNum();
        if (num == 1) num = 14; // AëŠ” íŒŒì¼ëª… ê·œì¹™ìƒ 14ë¡œ ì €ì¥ë¨

        String path = CARD_IMG_DIR + "Card" + num + c.getCShape() + ".png";

        ImageIcon icon = new ImageIcon(path);
        Image img = icon.getImage().getScaledInstance(240, 340, Image.SCALE_SMOOTH);
        return new ImageIcon(img);
    }

    private Icon loadBackIcon() {
        ImageIcon icon = new ImageIcon(CARD_BACK_IMG);
        Image img = icon.getImage().getScaledInstance(240, 340, Image.SCALE_SMOOTH);
        return new ImageIcon(img);
    }

    // ===============================
    //  UI Text Set
    // ===============================
    private void setInfo(String s) {
        lblInfo.setText(s);
    }

    // ===============================
    //  ì‹¤í–‰ ì‹œì‘
    // ===============================
    public static void main(String[] args) {
        SwingUtilities.invokeLater(PlayIndianPoker::new);
    }
}
